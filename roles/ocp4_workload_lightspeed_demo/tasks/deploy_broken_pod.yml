---
# Create namespace first to avoid race condition
- name: Create broken namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ ocp4_workload_lightspeed_demo_broken_pod_namespace }}"
    state: present
    wait: true
    wait_timeout: 60

# Wait for default service account to be created in the namespace
- name: Wait for default service account to be created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ServiceAccount
    name: default
    namespace: "{{ ocp4_workload_lightspeed_demo_broken_pod_namespace }}"
  register: sa_result
  until: sa_result.resources | length > 0
  retries: 10
  delay: 3

# Deploy the faulty pod after namespace is confirmed created
- name: Deploy broken pod
  kubernetes.core.k8s:
    template: deploy_broken_pod.yaml.j2
    wait: false
